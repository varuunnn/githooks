name: SQL Safety Check

on:
  pull_request:
    branches:
      - main

jobs:
  check-sql:
    name: Check for Dangerous SQL in PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Get list of changed SQL files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: '**/*.sql'

      - name: Scan SQL files for DELETE, DROP, TRUNCATE, or unsafe UPDATEs
        run: |
          found=0
          keywords='delete|drop|truncate'
          echo "Checking for dangerous SQL statements..."

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "ğŸ” Scanning: $file"

            inside_update=0
            update_statement=""
            update_start_line=0
            line_number=0

            while IFS= read -r line || [[ -n "$line" ]]; do
              line_number=$((line_number + 1))

              # Skip empty lines and comments (single-line comments start with '--')
              trimmed_no_space=$(echo "$line" | sed 's/^[ \t]*//')
              if [[ "$trimmed_no_space" == --* || -z "$line" ]]; then
                continue
              fi

              # Check for DELETE, DROP, TRUNCATE statements
              if echo "$line" | grep -Eiq "\b($keywords)\b"; then
                echo "âš ï¸ Dangerous SQL found at $file:$line_number"
                echo "  -> $line"
                found=1
              fi

              # Normalize line for easier detection (case-insensitive and trim spaces)
              trimmed_line=$(echo "$line" | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')

              # Start of UPDATE block
              if [[ "$trimmed_line" == update* ]]; then
                if [[ $inside_update -eq 1 ]]; then
                  # If previous UPDATE block didn't have a WHERE clause, report it
                  if ! echo "$update_statement" | grep -Eiq '\bwhere\b'; then
                    echo "âš ï¸ UPDATE without WHERE before line $line_number in $file"
                    echo "  -> $update_statement"
                    found=1
                  fi
                fi
                inside_update=1
                update_start_line=$line_number
                update_statement="$line"
                continue
              fi

              # Accumulate multi-line UPDATE
              if [[ $inside_update -eq 1 ]]; then
                update_statement="$update_statement $line"

                # If a new SQL statement starts (e.g., DELETE, INSERT, UPDATE, etc.)
                if echo "$line" | grep -Eq '^\s*(update|insert|delete|drop|truncate)'; then
                  if ! echo "$update_statement" | grep -Eiq '\bwhere\b'; then
                    echo "âš ï¸ UPDATE without WHERE near line $update_start_line in $file"
                    echo "  -> $update_statement"
                    found=1
                  fi
                  update_statement=""
                  inside_update=0
                  continue
                fi

                # If semicolon ends the statement
                if echo "$line" | grep -q ";"; then
                  if ! echo "$update_statement" | grep -Eiq '\bwhere\b'; then
                    echo "âš ï¸ UPDATE without WHERE near line $update_start_line in $file"
                    echo "  -> $update_statement"
                    found=1
                  fi
                  update_statement=""
                  inside_update=0
                fi
              fi
            done < "$file"

            # If file ends inside UPDATE block (e.g., multi-line UPDATE)
            if [[ $inside_update -eq 1 ]]; then
              if ! echo "$update_statement" | grep -Eiq '\bwhere\b'; then
                echo "âš ï¸ UPDATE without WHERE at line $update_start_line in $file"
                echo "  -> $update_statement"
                found=1
              fi
            fi
          done

          if [ "$found" -eq 1 ]; then
            echo "âŒ SQL safety check failed: dangerous statements found."
            exit 1
          else
            echo "âœ… All SQL checks passed."
          fi
